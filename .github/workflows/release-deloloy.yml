# workflow 이름 지정
name: deploy

on:
  #  workflow 를 trigger 조건 설정 - release/ 로 시작하는 branch 가 push 되었을 때 
  push:
    branches: [ main ]
  workflow_dispatch: # 수동 실행도 가능
    
# workflow의 실행은 하나 이상의 job으로 구성 됨
jobs:
  # 이 workflow 는 "deploy" 라는 single job 으로 구성
  deploy:
    # job이 실행될 환경 - 최신 mac os
    runs-on: macos-latest

    steps:
        # 1️⃣ 저장소 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Xcode 버전 설정 (visionOS SDK 포함)
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0.1'
      
      # 4️⃣ VisionOS 앱 아카이브 (.xcarchive)
      - name: Archive VisionOS app
        run: |
          xcodebuild \
            -project Visiom.xcodeproj \
            -scheme Visiom \
            -configuration Release \
            -destination 'generic/platform=visionOS' \
            -archivePath $PWD/build/Visiom.xcarchive \
            clean archive | xcpretty
          
      # 5️⃣ IPA 내보내기
      - name: Export IPA
        run: |
          xcodebuild \
            -exportArchive \
            -archivePath $PWD/build/Visiom.xcarchive \
            -exportPath $PWD/build/export \
            -exportOptionsPlist ExportOptions.plist
            
      # 6️⃣ TestFlight 업로드      
      - name: Upload app to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: build/export/Visiom.ipa
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
          
      # 7️⃣ 빌드 결과 아티팩트 업로드 (백업용)
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: VisionOS-Build
          path: build/export/
